pipeline {
    agent {
        label 'jenkins'
    }
    
    environment {
        PATH = "$PATH:/usr/local/go/bin"
    }

    stages {
        stage('Build') {
            steps {
                sh 'go build'
            }
        }
        
        stage('Test') {
            steps {
                sh 'go test'
            }
        }

        stage('Email Approval') {
            steps {
                mail to: 'sravanisoudampally@gmail.com',
                     subject: "Job '${JOB_NAME}' (${BUILD_NUMBER}) is waiting for input",
                     body: "Please go to ${BUILD_URL} and verify the build"
                input (message: 'Proceed with deployment?', ok: 'Deploy')
            }
        }

        stage('Deploy') {
            steps {
                script {
                    def goServerUsername = 'jenkins'
                    def goServerHost = '18.132.14.53'
                    def goServerPath = '/home/jenkins/go-project'
                    def localFilePath = '*'

                    // Use SCP to copy files to the Go server
                    sh "scp -r ${localFilePath} ${goServerUsername}@${goServerHost}:${goServerPath}"
                }
            }
        }
        
        stage('Run') {
            agent {
                label 'agent-node'
            }
            steps {
                script {
                    def goProjectDir = '/home/jenkins/go-project'
                    def goProgram = 'calculator.go'
                    
                    // Navigate to the Go project directory
                    dir(goProjectDir) {
                        // Run the Go program using nohup to detach it from the terminal
                        sh "nohup go run ${goProgram} &"
                    }
                }
               
               
            }
        }
    }
}
